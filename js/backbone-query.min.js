(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};(function(t){return t("backbone-query",function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;return y=t("underscore"),r=t("backbone"),c=function(e){var t,n,r,i,s,o,u;u=[];for(t in e){i=e[t],n={key:t};if(y.isRegExp(i))n.type="$regex",n.value=i;else if(t==="$and"||t==="$not"||t==="$or"||t==="$nor")n.type=t,n.value=i;else if(y(i).isObject()&&!y(i).isArray())for(s in i){o=i[s];if(g(s,o)){n.type=s;switch(s){case"$elemMatch":case"$relationMatch":n.value=c(o);break;case"$computed":r={},r[t]=o,n.value=c(r);break;default:n.value=o}}}else n.type="$equal",n.value=i;n.type==="$equal"&&y(n.value).isObject()&&(n.type="$oEqual"),u.push(n)}return u},g=function(e,t){switch(e){case"$in":case"$nin":case"$all":case"$any":return y(t).isArray();case"$size":return y(t).isNumber();case"$regex":return y(t).isRegExp();case"$like":case"$likeI":return y(t).isString();case"$between":return y(t).isArray()&&t.length===2;case"$cb":return y(t).isFunction();default:return!0}},m=function(e,t){switch(e){case"$like":case"$likeI":case"$regex":return y(t).isString();case"$contains":case"$all":case"$any":case"$elemMatch":return y(t).isArray();case"$size":return y(t).isArray()||y(t).isString();case"$in":case"$nin":return t!=null;case"$relationMatch":return t!=null&&t.models;default:return!0}},h=function(t,n,r,s,o){switch(t){case"$equal":return y(r).isArray()?e.call(r,n)>=0:r===n;case"$oEqual":return y(r).isEqual(n);case"$contains":return e.call(r,n)>=0;case"$ne":return r!==n;case"$lt":return r<n;case"$gt":return r>n;case"$lte":return r<=n;case"$gte":return r>=n;case"$between":return n[0]<r&&r<n[1];case"$in":return e.call(n,r)>=0;case"$nin":return e.call(n,r)<0;case"$all":return y(n).all(function(t){return e.call(r,t)>=0});case"$any":return y(r).any(function(t){return e.call(n,t)>=0});case"$size":return r.length===n;case"$exists":case"$has":return r!=null===n;case"$like":return r.indexOf(n)!==-1;case"$likeI":return r.toLowerCase().indexOf(n.toLowerCase())!==-1;case"$regex":return n.test(r);case"$cb":return n.call(s,r);case"$elemMatch":return f(r,n,!1,i,"elemMatch");case"$relationMatch":return f(r.models,n,!1,i,"relationMatch");case"$computed":return f([s],n,!1,i,"computed");case"$and":case"$or":case"$nor":case"$not":return p[t]([s],n).length===1;default:return!1}},f=function(e,t,n,r,i){var s;return i==null&&(i=!1),s=i?t:c(t),r(e,function(e){var t,r,o,u,a;for(u=0,a=s.length;u<a;u++){r=s[u],t=function(){var t;switch(i){case"elemMatch":return e[r.key];case"computed":return e[r.key]();default:return(t=r.key)==="$and"||t==="$or"||t==="$nor"||t==="$not"?r.key:e.get(r.key)}}(),o=m(r.type,t),o&&(o=h(r.type,r.value,t,e,r.key));if(n===o)return n}return!n})},s=function(e,t){var n,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],t(n)&&s.push(n);return s},d=function(e,t){var n,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],t(n)||s.push(n);return s},i=function(e,t){var n,r,i;for(r=0,i=e.length;r<i;r++){n=e[r];if(t(n))return!0}return!1},p={$and:function(e,t){return f(e,t,!1,s)},$or:function(e,t){return f(e,t,!0,s)},$nor:function(e,t){return f(e,t,!0,d)},$not:function(e,t){return f(e,t,!1,d)}},o=function(e,t,n){var r,i,s,o;return s=JSON.stringify(t),r=(o=e._query_cache)!=null?o:e._query_cache={},i=r[s],i||(i=a(e,t,n),r[s]=i),i},u=function(e,t){return p.$and(e.models,t)},a=function(e,t,n){var r;return r=u(e,t),n.sortBy&&(r=v(r,n)),r},v=function(e,t){return y(t.sortBy).isString()?e=y(e).sortBy(function(e){return e.get(t.sortBy)}):y(t.sortBy).isFunction()&&(e=y(e).sortBy(t.sortBy)),t.order==="desc"&&(e=e.reverse()),e},l=function(e,t){var n,r,i,s;return t.offset?i=t.offset:t.page?i=(t.page-1)*t.limit:i=0,n=i+t.limit,r=e.slice(i,n),t.pager&&y.isFunction(t.pager)&&(s=Math.ceil(e.length/t.limit),t.pager(s,r)),r},r.QueryCollection=r.Collection.extend({query:function(e,t){var n;return t==null&&(t={}),t.cache?n=o(this,e,t):n=a(this,e,t),t.limit&&(n=l(n,t)),n},where:function(e,t){return t==null&&(t={}),new this.constructor(this.query(e,t))},reset_query_cache:function(){return this._query_cache={}}}),n.QueryCollection=r.QueryCollection})}).call(this,typeof define=="function"&&define.amd?define:function(e,t){typeof exports!="undefined"?t(function(e){return require(e)},exports):t(function(e){return this[e==="underscore"?"_":"Backbone"]},{})})}).call(this)